# 개발 가이드라인

## 1. 환경 설정 관련

### 1.1 API 엔드포인트 설정 ⚠️
- ⚠️ 중요: 운영 서버 주소는 절대 변경하지 마세요! Render에서 할당된 고정 주소입니다.
- 프로덕션 환경: `https://user-behavior-analytics.onrender.com`
- 개발 환경: `http://localhost:3000`
- API URL 설정은 `user-analytics.js` 내부에서 자동으로 처리:
```javascript
window.API_BASE_URL = hostname === 'localhost' || hostname === '127.0.0.1'
    ? 'http://localhost:3000'
    : 'https://user-behavior-analytics.onrender.com';
```

### 1.2 CORS 설정
- 허용된 도메인:
  - 프로덕션: 
    - GitHub Pages: `https://whwnddml.github.io`
    - Brandiup: `https://*.brandiup.com` (와일드카드 지원)
  - 개발: `http://localhost:3000`, `http://127.0.0.1:3000`, `http://localhost:5500`
- CORS 설정 변경 방법:
  1. `render.yaml`의 `CORS_ORIGIN` 환경변수 수정
     ```yaml
     - key: CORS_ORIGIN
       value: "https://whwnddml.github.io,https://*.brandiup.com"
     ```
  2. 여러 도메인은 콤마(,)로 구분
  3. 와일드카드(`*`)를 사용하여 서브도메인 매칭 가능

### 1.3 환경 설정 파일 관리 ⚠️
- 모든 환경 설정은 `src/config/environment.ts`에서 중앙 관리
- 다른 설정 파일들은 `environment.ts`에서 설정을 가져와서 사용
- 설정 변경 시 체크리스트:
  - [ ] `environment.ts` 수정 시 해당 설정을 사용하는 모든 파일 확인
  - [ ] 데이터베이스 설정 변경 시 `database.ts` 영향 확인
  - [ ] 서버 설정 변경 시 `server/index.ts` 영향 확인
  - [ ] 타입 정의 일치 여부 확인

### 1.4 환경 변수
- 필수 환경 변수:
  - `DATABASE_URL`: 데이터베이스 연결 문자열
  - `NODE_ENV`: 실행 환경 ('development' 또는 'production')
- 환경 변수 변경 시:
  - [ ] `.env.example` 파일 업데이트
  - [ ] Render 대시보드에서 환경 변수 설정 확인
  - [ ] 로컬 개발 환경의 `.env` 파일 업데이트

## 2. API 통신

### 2.1 에러 처리
- 모든 API 호출은 try-catch로 감싸기
- 사용자에게 친숙한 에러 메시지 제공
- API 응답 구조 통일:
```javascript
{
  success: boolean,
  message: string,
  data: any
}
```

### 2.2 API 응답 처리
```javascript
const response = await fetch(`${API_BASE_URL}/api/...`);
if (!response.ok) throw new Error('API 요청 실패');

const result = await response.json();
if (!result.success) throw new Error(result.message);

// 성공 시 데이터 처리
handleData(result.data);
```

## 3. 배포 관련

### 3.1 프론트엔드 (GitHub Pages)
- 배포 전 체크리스트:
  - [ ] API 엔드포인트가 프로덕션 URL로 설정되어 있는지 확인
  - [ ] 콘솔 로그 제거
  - [ ] 개발용 코드 주석 제거
  - [ ] 크로스 브라우저 테스트
  - [ ] CORS 설정이 모든 필요한 도메인을 포함하는지 확인

### 3.2 백엔드 (Render)
- 배포 전 체크리스트:
  - [ ] `render.yaml` 설정 확인:
    - 데이터베이스 설정
    - 환경변수 설정
    - CORS 설정
    - 빌드 및 시작 명령어
  - [ ] 데이터베이스 연결 설정:
    - SSL 설정 확인
    - 연결 풀 설정 확인
    - 재시도 로직 동작 확인
  - [ ] 헬스체크 엔드포인트 (`/api/health`) 동작 확인
  - [ ] 로그 레벨 설정 확인
  - [ ] 데이터베이스 마이그레이션 스크립트 확인

### 3.3 데이터베이스 설정
- 연결 풀 설정:
  ```typescript
  {
    max: 20,            // 최대 클라이언트 수
    min: 2,             // 최소 유지 연결 수
    idleTimeoutMillis: 30000,    // 유휴 연결 타임아웃 (30초)
    connectionTimeoutMillis: 5000 // 연결 타임아웃 (5초)
  }
  ```
- 재시도 로직:
  - 최대 5회 재시도
  - 2초 간격으로 재시도
  - 상세한 로깅 제공

### 3.4 운영 환경 특이사항
- Render 무료 플랜 제한사항:
  - 15분 비활성 시 슬립 모드 전환
  - 월 750시간 사용 제한
  - PostgreSQL 1GB 저장소 제한
- 콜드 스타트:
  - 첫 요청 시 1-2분 지연 가능
  - 자동 재시도 로직으로 대응
- 데이터베이스 연결:
  - SSL 필수 사용
  - 연결 풀 관리 자동화
  - 상세 모니터링 로그 제공

## 4. 테스트

### 4.1 로컬 테스트
1. 백엔드 서버 실행: `npm run dev`
2. 프론트엔드 Live Server 실행
3. API 통신 테스트
4. 크로스 브라우저 테스트

### 4.2 프로덕션 테스트
1. GitHub Pages 배포 후 실제 도메인에서 테스트
2. Render 백엔드 연동 확인
3. CORS 정상 작동 확인
4. 실제 사용자 시나리오 테스트

## 5. 문제 해결

### 5.1 일반적인 문제
- CORS 오류: 백엔드 CORS 설정 확인
- API 404 오류: 엔드포인트 URL 확인
- API 연결 실패: 백엔드 서버 상태 확인

### 5.2 디버깅
- 브라우저 개발자 도구의 Network 탭 활용
- 백엔드 로그 확인
- API 응답 구조 확인

## 6. 코드 컨벤션

### 6.1 프론트엔드
- 일관된 API 호출 패턴 사용
- 에러 처리 통일
- 사용자 친화적인 UI/UX 유지

### 6.2 백엔드
- RESTful API 설계 원칙 준수
- 일관된 응답 구조 유지
- 적절한 HTTP 상태 코드 사용

## 7. 보안

### 7.1 프론트엔드
- 민감한 정보 노출 방지
- XSS 방어
- HTTPS 사용

### 7.2 백엔드
- 적절한 인증/인가 처리
- 입력값 검증
- Rate Limiting 적용 

## 8. API 문서

### 8.1 API 엔드포인트 목록

#### 데이터 수집 API
- **POST** `/api/analytics/collect`
  - 사용자 행동 데이터 수집
  - Request Body: `ClientAnalyticsData`
  - Response: `{ success: true, message: string, data: { sessionId: string, pageviewId: number } }`

#### 대시보드 API
- **GET** `/api/analytics/dashboard/stats`
  - 대시보드 통계 데이터 조회
  - Query Parameters:
    - `dateFrom`: 시작일 (YYYY-MM-DD)
    - `dateTo`: 종료일 (YYYY-MM-DD)
    - `page`: 페이지 URL (선택사항)
  - Response: `{ success: true, message: string, data: DashboardStats[] }`

- **GET** `/api/analytics/dashboard/sessions`
  - 세션 목록 조회
  - Query Parameters:
    - `limit`: 조회할 세션 수 (기본값: 50)
    - `offset`: 시작 위치 (기본값: 0)
  - Response: `{ success: true, message: string, data: Session[] }`

#### 상세 분석 API
- **GET** `/api/analytics/sessions/:sessionId`
  - 특정 세션의 상세 정보 조회
  - Parameters:
    - `sessionId`: 세션 ID
  - Response: `{ success: true, message: string, data: SessionDetail }`

- **GET** `/api/analytics/area-stats`
  - 영역별 통계 조회
  - Query Parameters:
    - `dateFrom`: 시작일 (YYYY-MM-DD)
    - `dateTo`: 종료일 (YYYY-MM-DD)
  - Response: `{ success: true, message: string, data: AreaStats[] }`

- **GET** `/api/analytics/hourly-stats`
  - 시간대별 활동 통계 조회
  - Query Parameters:
    - `dateFrom`: 시작일 (YYYY-MM-DD)
    - `dateTo`: 종료일 (YYYY-MM-DD)
  - Response: `{ success: true, message: string, data: HourlyStats[] }`

- **GET** `/api/analytics/device-stats`
  - 디바이스별 통계 조회
  - Query Parameters:
    - `dateFrom`: 시작일 (YYYY-MM-DD)
    - `dateTo`: 종료일 (YYYY-MM-DD)
  - Response: `{ success: true, message: string, data: DeviceStats[] }`

- **GET** `/api/analytics/performance-stats`
  - 페이지 성능 통계 조회
  - Query Parameters:
    - `dateFrom`: 시작일 (YYYY-MM-DD)
    - `dateTo`: 종료일 (YYYY-MM-DD)
  - Response: `{ success: true, message: string, data: PerformanceStats[] }`

### 8.2 API 응답 구조
모든 API는 다음과 같은 표준 응답 구조를 따릅니다:
```typescript
interface ApiResponse<T = any> {
  success: boolean;      // API 호출 성공 여부
  message: string;       // 응답 메시지
  data?: T;             // 응답 데이터 (선택사항)
  error?: string;       // 에러 메시지 (실패 시)
}
```

### 8.3 에러 처리
- 모든 API는 에러 발생 시 적절한 HTTP 상태 코드와 함께 에러 응답을 반환합니다.
- 주요 HTTP 상태 코드:
  - 200: 성공
  - 201: 생성 성공
  - 400: 잘못된 요청
  - 404: 리소스 없음
  - 500: 서버 에러

### 8.4 API 사용 예시
```javascript
// API 호출 예시
async function fetchDashboardStats() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/analytics/dashboard/stats?dateFrom=2024-01-01&dateTo=2024-01-31`);
    if (!response.ok) throw new Error('API 요청 실패');
    
    const result = await response.json();
    if (!result.success) throw new Error(result.message);
    
    return result.data;
  } catch (error) {
    console.error('데이터 로드 실패:', error);
    throw error;
  }
}
``` 

## 운영 환경 설정

### 백엔드 서버 (Render)

현재 백엔드 서버는 Render 플랫폼에서 호스팅되고 있습니다.

- **서비스 URL**: https://user-behavior-analytics.onrender.com
- **서비스 타입**: Web Service
- **환경**: Node.js
- **빌드 명령어**: `npm install && tsc && node dist/utils/initDB.js`
- **시작 명령어**: `npm start`
- **헬스체크 경로**: `/api/analytics/health`

### 데이터베이스 (Render PostgreSQL)

- **데이터베이스 이름**: uba_zfqs
- **호스트**: dpg-d18v2effte5s73bqn5dg-a.oregon-postgres.render.com
- **사용자**: brandiup
- **연결 문자열 형식**: `postgresql://brandiup:[password]@dpg-d18v2effte5s73bqn5dg-a.oregon-postgres.render.com/uba_zfqs`

### 환경 변수 설정

```env
NODE_ENV=production
DATABASE_URL=postgresql://brandiup:[password]@dpg-d18v2effte5s73bqn5dg-a.oregon-postgres.render.com/uba_zfqs
CORS_ORIGIN=https://whwnddml.github.io,https://*.brandiup.com
LOG_LEVEL=info
```

## 문제 해결 가이드

### 데이터베이스 관련 오류 구분

1. **연결 오류 (Connection Error)**
   - 에러 메시지: `ECONNREFUSED`, `connection terminated`, `timeout`
   - 원인: 데이터베이스 서버 접근 불가, 네트워크 문제, 인증 실패
   - 확인사항:
     - DATABASE_URL 환경변수가 올바른지 확인
     - Render 대시보드에서 데이터베이스 서비스 상태 확인
     - IP 허용 목록 확인

2. **쿼리 오류 (Query Error)**
   - 에러 메시지: `column must appear in the GROUP BY clause`, `syntax error`, `relation does not exist`
   - 원인: SQL 문법 오류, 테이블/컬럼 불일치, GROUP BY 규칙 위반
   - 해결방법:
     - SQL 쿼리 문법 검토
     - GROUP BY 절에 모든 비집계 컬럼 포함
     - 테이블과 컬럼 이름 확인

⚠️ **중요**: 쿼리 오류와 연결 오류를 혼동하지 마세요!
- 500 에러가 발생하더라도 반드시 에러 로그를 확인하여 정확한 원인 파악
- 데이터베이스 연결은 정상이지만 쿼리에서 오류가 발생할 수 있음
- 운영 환경의 데이터베이스 설정은 Render에서 관리되므로 임의 변경 금지

### 로그 확인 방법

1. **서버 로그**
   ```bash
   # Render 대시보드에서 확인
   # 또는 로컬 개발 환경에서
   tail -f backend/logs/server.log
   ```

2. **데이터베이스 연결 테스트**
   ```bash
   # 헬스체크 API 호출
   curl https://user-behavior-analytics.onrender.com/api/analytics/health
   ```

### 개발 환경 설정

로컬 개발 시에는 다음 설정을 사용하세요:

```env
NODE_ENV=development
DATABASE_URL=postgres://postgres:postgres@localhost:5432/analytics
CORS_ORIGIN=http://localhost:3000,http://localhost:5500
LOG_LEVEL=debug
```

## 배포 프로세스

1. **자동 배포 (Auto-Deploy)**
   - 코드 변경사항을 main 브랜치에 푸시
   - Render가 자동으로 새로운 배포 시작
   - 배포 로그에서 빌드 및 시작 과정 모니터링
   - 헬스체크 엔드포인트로 서비스 상태 확인

2. **수동 배포 (Deploy Hook 사용)**
   - Deploy Hook URL을 사용하여 수동으로 배포 트리거 가능
   - URL 형식: `https://api.render.com/deploy/[service-id]?key=[secret-key]`
   - 사용 방법:
     ```bash
     # curl을 사용한 배포 트리거
     curl -X POST [Deploy-Hook-URL]
     ```
   - ⚠️ 주의: Deploy Hook URL은 비밀 정보이므로 절대 공개되지 않도록 관리

3. **Deploy Hook 활용 사례**
   - 데이터베이스 마이그레이션 후 서버 재배포
   - CI/CD 파이프라인에서 자동 배포
   - 특정 조건에서 서버 재배포가 필요한 경우

4. **보안 주의사항**
   - Deploy Hook URL이 노출되면 즉시 "Regenerate hook"으로 새로 생성
   - 배포 로그를 통해 의도하지 않은 배포 여부 모니터링
   - 자동 배포와 수동 배포의 히스토리 관리

## 모니터링

1. **서비스 상태 모니터링**
   - Render 대시보드의 서비스 메트릭 확인
   - 헬스체크 엔드포인트 주기적 호출

2. **데이터베이스 모니터링**
   - Render 대시보드의 데이터베이스 메트릭 확인
   - 연결 풀 상태 및 쿼리 성능 모니터링

## 주의사항

1. **운영 환경 설정 변경**
   - Render 대시보드를 통해서만 설정 변경
   - 데이터베이스 연결 정보는 변경하지 않음
   - 환경 변수는 Render 대시보드에서 관리

2. **문제 해결 시**
   - 에러 메시지를 정확히 분석
   - 연결 문제와 쿼리 문제를 명확히 구분
   - 불필요한 설정 변경 지양

3. **코드 변경 시**
   - SQL 쿼리 변경 시 GROUP BY 규칙 준수
   - 데이터베이스 연결 설정은 render.yaml 참고
   - 환경변수는 .env.example 참고 

## GitHub Actions 자동 배포 설정

1. **배포 자동화 구성**
   - `.github/workflows/backend-deploy.yml` - 백엔드 배포 설정
   - `.github/workflows/frontend-deploy.yml` - 프론트엔드 배포 설정
   - backend 코드 변경 시 자동으로 Render 배포 트리거
   - frontend 코드 변경 시 자동으로 GitHub Pages 배포 트리거
   - GitHub Secrets에 `RENDER_DEPLOY_HOOK_URL` 설정 필요

2. **GitHub Secrets 설정 방법**
   - GitHub 저장소 Settings > Secrets and variables > Actions
   - "New repository secret" 클릭
   - Name: `RENDER_DEPLOY_HOOK_URL`
   - Value: Render Deploy Hook URL 입력
   - "Add secret" 클릭

3. **자동 배포 모니터링**
   - GitHub Actions 탭에서 배포 워크플로우 확인
   - Render 대시보드에서 배포 상태 확인
   - 배포 실패 시 GitHub Actions 로그 확인 

4. **배포 워크플로우 테스트 방법**
   - GitHub 저장소의 "Actions" 탭 방문
   - 테스트할 워크플로우 선택:
     - "Deploy Frontend to GitHub Pages"
     - "Backend Auto Deploy"
   - "Run workflow" 버튼 클릭
   - "Run from: main" 브랜치 선택
   - "Run workflow" 클릭하여 실행

5. **배포 결과 확인**
   - 프론트엔드:
     - GitHub Actions 실행 로그 확인
     - GitHub Pages URL 접속 테스트
     - 페이지 기능 정상 동작 확인
   - 백엔드:
     - GitHub Actions 실행 로그 확인
     - Render 대시보드에서 배포 상태 확인
     - API 엔드포인트 응답 테스트

6. **문제 해결**
   - 배포 실패 시 Actions 로그 상세 확인
   - Render 로그에서 백엔드 에러 확인
   - 환경 변수 설정 검증
   - 권한 설정 확인 