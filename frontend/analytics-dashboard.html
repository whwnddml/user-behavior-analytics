<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 행동 분석 대시보드</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- API 설정 -->
    <script src="js/api-config.js"></script>
    
    <!-- 커스텀 스타일 -->
    <link href="css/common.css" rel="stylesheet">
    <link href="css/analytics-dashboard.css" rel="stylesheet">

    <style>
        /* 반응형 테이블 스타일 */
        .table-responsive {
            margin-bottom: 1rem;
        }

        .table td, .table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* 기본 최대 너비 설정 */
        }

        /* 세션 ID 열 */
        .table td.session-id {
            max-width: 200px;
        }

        /* 브라우저 정보 열 */
        .table td.browser-info {
            max-width: 120px;
        }

        /* 숫자 데이터 열 */
        .table td.number-col {
            max-width: 80px;
            text-align: right;
        }

        /* 날짜 열 */
        .table td.date-col {
            max-width: 150px;
        }

        /* 디바이스 타입 열 */
        .table td.device-col {
            max-width: 100px;
        }

        /* 반응형 조정 */
        @media (max-width: 768px) {
            .table td, .table th {
                max-width: 120px;
            }
            
            .table td.session-id {
                max-width: 150px;
            }

            .table td.browser-info {
                max-width: 100px;
            }

            .table td.date-col {
                max-width: 120px;
            }
        }

        @media (max-width: 576px) {
            .table td, .table th {
                max-width: 100px;
            }
            
            .table td.session-id {
                max-width: 120px;
            }

            .table td.browser-info {
                max-width: 80px;
            }

            .table td.date-col {
                max-width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary py-2">
        <div class="container">
            <a class="navbar-brand" href="#">사용자 행동 분석</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="analytics-dashboard.html">메인 대시보드</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="simple-dashboard.html">간단한 대시보드</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="test-frontend.html">테스트 페이지</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">사용자 행동 분석 대시보드</h1>
        
        <!-- 에러 메시지 -->
        <div id="error-message" class="error-message"></div>

        <!-- 필터 섹션 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="date-from" class="form-label">시작일</label>
                        <input type="date" id="date-from" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="date-to" class="form-label">종료일</label>
                        <input type="date" id="date-to" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="page-filter" class="form-label">페이지</label>
                        <select id="page-filter" class="form-control">
                            <option value="/index.html">메인 페이지</option>
                            <option value="/example-page.html">예시 페이지</option>
                            <option value="/test-frontend.html">테스트 페이지</option>
                            <option value="/static/html/skybab.html">스카이밥</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button onclick="loadDashboardData()" class="btn btn-primary w-100">
                            새로고침
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">총 세션</h5>
                        <h2 id="total-sessions" class="mb-0">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">총 페이지뷰</h5>
                        <h2 id="total-pageviews" class="mb-0">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">총 클릭수</h5>
                        <h2 id="total-interactions" class="mb-0">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">평균 세션 시간</h5>
                        <h2 id="avg-session-time" class="mb-0">-</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- 차트 영역 -->
        <div class="row">
            <!-- 영역별 체류시간 차트 -->
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">영역별 체류시간 및 클릭수</h5>
                        <div class="chart-container">
                            <canvas id="areaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 디바이스별 통계 차트 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">디바이스별 통계</h5>
                        <div class="chart-container">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 브라우저별 통계 차트 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">브라우저별 통계</h5>
                        <div class="chart-container">
                            <canvas id="browserChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 시간대별 활동 차트 -->
            <div class="col-md-12">
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">시간대별 활동</h5>
                        <div class="chart-container">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 세션 테이블 -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">최근 세션</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>세션 ID</th>
                                <th>시작 시간</th>
                                <th>디바이스</th>
                                <th>브라우저</th>
                                <th>페이지뷰</th>
                                <th>클릭수</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-table-body">
                            <tr>
                                <td colspan="6" class="text-center">데이터를 불러오는 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- API 설정 -->
    <script src="js/api-config.js"></script>
    
    <!-- 분석 스크립트 -->
    <script>
        // 전역 차트 객체
        let charts = {
            areaChart: null,
            deviceChart: null,
            browserChart: null,
            timeChart: null
        };

        // 차트 초기화 함수
        function initializeCharts() {
            // 영역별 체류시간 차트
            const areaCtx = document.getElementById('areaChart').getContext('2d');
            charts.areaChart = new Chart(areaCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '방문자 수',
                            data: [],
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '평균 체류시간(초)',
                            data: [],
                            type: 'line',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y1'
                        },
                        {
                            label: '클릭수',
                            data: [],
                            type: 'line',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: '방문자 수'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '평균 체류시간(초)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: '클릭수'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });

            // 디바이스별 통계 차트
            const deviceCtx = document.getElementById('deviceChart').getContext('2d');
            charts.deviceChart = new Chart(deviceCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // 브라우저별 통계 차트
            const browserCtx = document.getElementById('browserChart').getContext('2d');
            charts.browserChart = new Chart(browserCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // 시간대별 활동 차트
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            charts.timeChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}시`),
                    datasets: [
                        {
                            label: '세션 수',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true
                        },
                        {
                            label: '페이지뷰',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 페이지 로드 시 차트 초기화 및 데이터 로드
        document.addEventListener('DOMContentLoaded', () => {
            // 오늘 날짜를 기본값으로 설정
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('date-from').value = dateStr;
            document.getElementById('date-to').value = dateStr;

            // 페이지 필터의 첫 번째 옵션 선택
            const pageFilter = document.getElementById('page-filter');
            if (pageFilter.options.length > 0) {
                pageFilter.selectedIndex = 0;
            }

            initializeCharts();
            loadDashboardData();
        });

        // 대시보드 데이터 로드
        async function loadDashboardData() {
            try {
                const startDate = document.getElementById('date-from').value;
                const endDate = document.getElementById('date-to').value;
                const pageFilter = document.getElementById('page-filter').value;

                console.log('Loading data with params:', { startDate, endDate, pageFilter });

                const params = new URLSearchParams();
                if (startDate) params.append('startDate', `${startDate}T00:00:00`);
                if (endDate) params.append('endDate', `${endDate}T23:59:59`);
                params.append('page', pageFilter); // 페이지 필터는 항상 포함

                const response = await fetch(`${API_BASE_URL}/dashboard/stats?${params}`);
                const data = await response.json();

                console.log('Received data:', data);

                if (!data.success) {
                    throw new Error(data.error || '데이터 로드 실패');
                }

                updateDashboard(data.data);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('error-message').textContent = error.message;
            }
        }

        // 대시보드 업데이트
        function updateDashboard(data) {
            console.log('Updating dashboard with data:', data);

            if (!data || !data.overview) {
                console.error('Invalid data format:', data);
                document.getElementById('error-message').textContent = '유효하지 않은 데이터 형식';
                return;
            }

            try {
                // 통계 카드 업데이트
                document.getElementById('total-sessions').textContent = data.overview.total_sessions.toLocaleString();
                document.getElementById('total-pageviews').textContent = data.overview.total_pageviews.toLocaleString();
                document.getElementById('total-interactions').textContent = data.overview.total_interactions.toLocaleString();
                document.getElementById('avg-session-time').textContent = formatTime(data.overview.avg_session_time);

                // 영역별 체류시간 차트 업데이트
                if (data.areas && Array.isArray(data.areas)) {
                    charts.areaChart.data.labels = data.areas.map(area => area.area_name);
                    charts.areaChart.data.datasets[0].data = data.areas.map(area => area.visitor_count);
                    charts.areaChart.data.datasets[1].data = data.areas.map(area => area.avg_time_spent);
                    charts.areaChart.data.datasets[2].data = data.areas.map(area => area.click_count || 0);
                    charts.areaChart.update();
                }

                // 디바이스별 통계 차트 업데이트
                if (data.devices && Array.isArray(data.devices)) {
                    charts.deviceChart.data.labels = data.devices.map(device => device.device_type);
                    charts.deviceChart.data.datasets[0].data = data.devices.map(device => device.session_count);
                    charts.deviceChart.update();
                }

                // 브라우저별 통계 차트 업데이트
                if (data.browsers && Array.isArray(data.browsers)) {
                    const browserData = data.browsers.reduce((acc, browser) => {
                        const key = `${browser.browser} ${browser.version}`;
                        acc.labels.push(key);
                        acc.data.push(browser.session_count);
                        return acc;
                    }, { labels: [], data: [] });

                    charts.browserChart.data.labels = browserData.labels;
                    charts.browserChart.data.datasets[0].data = browserData.data;
                    charts.browserChart.update();
                }

                // 시간대별 활동 차트 업데이트
                if (data.hourly && Array.isArray(data.hourly)) {
                    const hourlyData = Array(24).fill(0).map((_, i) => {
                        const hourData = data.hourly.find(h => h.hour === i) || { session_count: 0, pageview_count: 0 };
                        return {
                            session_count: hourData.session_count,
                            pageview_count: hourData.pageview_count
                        };
                    });

                    charts.timeChart.data.datasets[0].data = hourlyData.map(h => h.session_count);
                    charts.timeChart.data.datasets[1].data = hourlyData.map(h => h.pageview_count);
                    charts.timeChart.update();
                }

                // 세션 테이블 업데이트
                const tbody = document.getElementById('sessions-table-body');
                if (data.recent_sessions && Array.isArray(data.recent_sessions)) {
                    if (data.recent_sessions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">데이터가 없습니다.</td></tr>';
                    } else {
                        tbody.innerHTML = data.recent_sessions.map(session => {
                            const truncatedId = session.session_id.length > 50 
                                ? session.session_id.substring(0, 50) + '...' 
                                : session.session_id;
                            
                            return `
                            <tr>
                                <td class="session-id" title="${session.session_id}" style="cursor: help;">
                                    ${truncatedId}
                                </td>
                                <td class="date-col" title="${formatDate(session.start_time)}">
                                    ${formatDate(session.start_time)}
                                </td>
                                <td class="device-col" title="${session.device_type}">
                                    ${session.device_type}
                                </td>
                                <td class="browser-info" title="${session.browser_name} ${session.browser_version}">
                                    ${session.browser_name} ${session.browser_version}
                                </td>
                                <td class="number-col">
                                    ${session.pageviews}
                                </td>
                                <td class="number-col">
                                    ${session.total_interactions}
                                </td>
                            </tr>
                        `}).join('');

                        // 툴팁 초기화
                        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
                        tooltipTriggerList.map(function (tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl);
                        });
                    }
                }

                // 에러 메시지 초기화
                document.getElementById('error-message').textContent = '';
            } catch (error) {
                console.error('Error updating dashboard:', error);
                document.getElementById('error-message').textContent = '대시보드 업데이트 중 오류 발생';
            }
        }

        // 시간 포맷 함수
        function formatTime(seconds) {
            if (!seconds) return '0초';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return minutes > 0 ? `${minutes}분 ${remainingSeconds}초` : `${remainingSeconds}초`;
        }

        // 날짜 포맷 함수
        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }
    </script>
</body>
</html> 